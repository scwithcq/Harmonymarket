import http from '@ohos.net.http';
import { promptAction } from '@kit.ArkUI';
import { FloatingCartButton } from '../../../components/FloatingCartButton';

interface ChatMessage {
  role: 'user' | 'assistant';
  content: string;
}

interface AskRequest {
  question: string;
  use_rag: boolean;
}

interface RetrievedDoc {
  content: string;
  score?: number;
  distance?: number;
}

interface AskResponse {
  answer: string;
  retrieved_docs: Array<RetrievedDoc>;
  timestamp: string;
}

@Builder
export function RecipePageBuilder() {
  RecipePage()
}

@Component
struct RecipePage {
  @State messages: Array<ChatMessage> = [];
  @State inputText: string = '';
  @State isLoading: boolean = false;
  @StorageProp('globalPageStack') @Watch('onPageStackChange') pageStack: NavPathStack = new NavPathStack();
  private scroller: Scroller = new Scroller();
  
  aboutToAppear() {
    // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
    this.messages.push({
      role: 'assistant',
      content: 'ä½ å¥½ï¼æˆ‘æ˜¯èœè°±åŠ©æ‰‹ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ğŸ˜Š\n\næ‚¨å¯ä»¥ï¼š\nâ€¢ è¾“å…¥é£Ÿæåç§°ï¼Œæˆ‘ä¼šæ¨èç›¸å…³èœè°±\nâ€¢ è¯¢é—®çƒ¹é¥ªæŠ€å·§å’Œæ­¥éª¤\nâ€¢ å’¨è¯¢é£Ÿææ­é…å»ºè®®\n\nè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ'
    });
  }
  
  // ç›‘å¬ pageStack å˜åŒ–
  onPageStackChange() {
    console.info('[RecipePage] pageStack å·²æ›´æ–°');
  }

  private async sendQuestion() {
    if (this.inputText.trim() === '') {
      promptAction.showToast({ message: 'è¯·è¾“å…¥é—®é¢˜' });
      return;
    }

    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    this.messages.push({ role: 'user', content: this.inputText });

    const questionText = this.inputText;
    this.inputText = '';
    this.isLoading = true;

    try {
      const reqData: AskRequest = {
        question: questionText,
        use_rag: true
      };

      const httpRequest = http.createHttp();
      const response = await httpRequest.request(
        // 'http://172.17.136.7:8080/api/ask',
        'http://tf76667a.natappfree.cc/api/ask',
        {
          method: http.RequestMethod.POST,
          extraData: JSON.stringify(reqData),
          header: { 'Content-Type': 'application/json' },
          expectDataType: http.HttpDataType.STRING,
          connectTimeout: 8000,
          readTimeout: 15000
        }
      );

      if (response.responseCode === 200 && response.result) {
        const data: AskResponse = JSON.parse(response.result as string);
        this.messages.push({ role: 'assistant', content: data.answer });
        // æ»šåŠ¨åˆ°åº•éƒ¨
        this.scroller.scrollEdge(Edge.Bottom);
      } else {
        promptAction.showToast({ message: 'è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨' });
      }

      httpRequest.destroy();
    } catch (err) {
      console.error('è¯·æ±‚å‡ºé”™: ', JSON.stringify(err));
      promptAction.showToast({ message: 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•' });
    } finally {
      this.isLoading = false;
    }
  }

  build() {
    NavDestination() {
      Column({ space: 12 }) {
        // é¡¶éƒ¨æ ‡é¢˜æ 
        Text('èœè°±åŠ©æ‰‹')
        .fontSize(26)
        .fontWeight(FontWeight.Bold)
        .padding(12)
        .backgroundColor(Color.White) // é»‘ç™½ç®€çº¦
        .fontColor(Color.Black)
        .width('100%')
        .textAlign(TextAlign.Center)

      // èŠå¤©å†…å®¹æ˜¾ç¤ºåŒº
      Scroll(this.scroller) {
        Column({ space: 10 }) {
          ForEach(this.messages, (msg: ChatMessage, index: number) => {
            if (msg.role === 'user') {
              Row() {
                Blank() // å ä½è®©ç”¨æˆ·æ¶ˆæ¯é å³
                Text(msg.content)
                  .padding(10)
                  .backgroundColor('#4CAF50') // ç”¨æˆ·æ¶ˆæ¯ç»¿è‰²
                  .fontColor(Color.White)
                  .borderRadius(10)
                  .width('70%')
              }.width('100%')
            } else {
              Row() {
                Text(msg.content)
                  .padding(10)
                  .backgroundColor('#F5F5F5') // åŠ©æ‰‹æ¶ˆæ¯æµ…ç°
                  .fontColor(Color.Black)
                  .borderRadius(10)
                  .width('70%')
                Blank()
              }.width('100%')
            }
          }, (msg: ChatMessage) => msg.content)
        }
        .padding(12)
      }.height('80%')

      // åŠ è½½æç¤º
      if (this.isLoading) {
        Text('æ­£åœ¨ç”Ÿæˆèœè°±...')
          .fontSize(16)
          .fontColor('#888888')
      }

      // åº•éƒ¨è¾“å…¥æ 
      Row({ space: 8 }) {
        TextInput({ placeholder: 'è¯·è¾“å…¥é£Ÿææˆ–é—®é¢˜', text: $$this.inputText })
          .width('75%')
          .height(40)
          .borderRadius(8)
          .backgroundColor('#F5F5F5')
          .padding({ left: 10 })

        Button('å‘é€')
          .width('20%')
          .height(40)
          .backgroundColor('#4CAF50')
          .fontColor(Color.White)
          .borderRadius(8)
          .enabled(!this.isLoading)
          .opacity(this.isLoading ? 0.5 : 1)
          .onClick(() => {
            this.sendQuestion();
          })
      }
      .padding(10)
      }
      .backgroundColor(Color.White) // é¡µé¢èƒŒæ™¯ç™½è‰²
      .height('100%')
      .width('100%')
      
      // æ‚¬æµ®è´­ç‰©è½¦æŒ‰é’®
      FloatingCartButton({ pageStack: this.pageStack })
    }
    .hideTitleBar(true)
    .onReady((context: NavDestinationContext) => {
      // ä¹Ÿå¯ä»¥ä» context è·å–ï¼Œä½œä¸ºå¤‡ç”¨
      if (!this.pageStack) {
        this.pageStack = context.pathStack;
      }
    })
  }
}

export { RecipePage };
