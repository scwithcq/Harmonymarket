// File: src/main/ets/pages/Users/Home/SearchResultPage.ets
import router from '@ohos.router';
import http from '@ohos.net.http';
import { app_color } from '../../../utils/Colors'
import { LayoutBuilder } from '../../Layout';
import { promptAction } from '@kit.ArkUI';
import display from '@ohos.display';

// å•†å“æ•°æ®ç±»å‹
export interface ProductDataItem {
  id: number;
  name: string;
  price: number;
  unit: string;
  imageUrl: string;
  isRecommend?: number;
  isNew?: number;
}

interface GeneratedTypeLiteralInterface_1 {
  item: ProductDataItem[];
}

export interface ProductResultData {
  success: boolean;
  data: GeneratedTypeLiteralInterface_1;
  code: number;
  message: string;
}

// æ¨¡æ‹Ÿå™¨è®¿é—®å®¿ä¸»æœºåœ°å€
// const BASE_URL = 'http://10.0.2.2:8080/api';  //è¿™ä¸ªç”¨æ¥æ¨¡æ‹Ÿæœºæµ‹è¯•
// const BASE_URL = 'http://192.168.85.10:8080/api'; //è¿™ä¸ªåœ¨è¿æ¥æˆ‘çš„çƒ­ç‚¹70æµ‹è¯•
const BASE_URL = 'http://s49b7b66.natappfree.cc/api'; //è¿™ä¸ªä¸ºçŸ­æš‚ï¼ˆ3å¤©ï¼‰å…¬ç½‘æµ‹è¯• æ˜ å°„åˆ°åç«¯çš„localhost:8080


@Builder
export function SearchProductPageBuilder() {
  SearchProductPage()
}


@Component
struct SearchProductPage {
  private animateCart: boolean = false
  @State keyword: string = '';
  @State productList: ProductDataItem[] = [];
  @State isLoading: boolean = true;
  @State cartVisible: Visibility = Visibility.Visible
  @State offsetX: number = 0
  @State offsetY: number = 0
  //è¿™é‡Œç”¨æ¥æ¸²æŸ“å•†å“å›¾ç‰‡çš„æ”¾å¤§
  @State showBig: boolean = false // æ˜¯å¦å¤„äºæ”¾å¤§æ€
  @State bigUrl: string = '' // è¦æ”¾å¤§å“ªå¼ å›¾
  @State bigShown: boolean = false
  @State productName: string = '';

  // null! è¡¨ç¤ºâ€œå¤–éƒ¨ä¼šé©¬ä¸Šèµ‹å€¼â€
  @State pageStack: NavPathStack = null!;// å…ˆå ä½ï¼Œç­‰ onReady èµ‹å€¼

  // é¡µé¢æ˜¾ç¤ºå‰è·å–è·¯ç”±å‚æ•°
/*  aboutToAppear() {
    const params = router.getParams() as Record<string, string>;
    this.keyword = params?.keyword ?? '';
    if (this.keyword) {
      this.fetchProductData();
    }
    if (this.animateCart) {
      this.startState()
    } else {
      this.cartVisible = Visibility.None
    }

  }*/

  // onAppear(event: () => void): CommonAttribute {
  // 	return this.startState();
  // }

  // è°ƒç”¨åç«¯æ¥å£è·å–å•†å“æ•°æ®
  async fetchProductData() {
    this.isLoading = true;
    const httpReq = http.createHttp();
    const url = `${BASE_URL}/products?keyword=${encodeURIComponent(this.keyword)}`;

    try {
      const resp = await httpReq.request(url, { method: http.RequestMethod.GET });
      if (resp.responseCode === 200) {
        const result: ProductResultData = JSON.parse(resp.result.toString());
        if (result.success && result.data?.item) {
          this.productList = result.data.item;
        } else {
          this.productList = [];
        }
      } else {
        console.error(`è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${resp.responseCode}`);
        this.productList = [];
      }
    } catch (err) {
      console.error('è¯·æ±‚å¼‚å¸¸:', err);
      this.productList = [];
    } finally {
      httpReq.destroy();
      this.isLoading = false;
    }
  }

  //å®šä¹‰ä¸€ä¸ªè´­ç‰©è½¦ä»å·¦åˆ°å³çš„å¹³ç§»æ–¹æ³•
  private startState(): void {
    this.offsetX = this.offsetX === 0 ? 70 : 70
    this.offsetY === 0
  }
  build() {
    // å­ç±»é¡µé¢ï¼Œä¸éœ€è¦è·³è½¬çš„æ—¶å€™ä½¿ç”¨
    NavDestination() {
      Column({ space: 12 }) {
        // 1. é¡¶éƒ¨æœç´¢æ ï¼ˆé€šæ å¡ç‰‡ç‰ˆï¼‰
        Row() {
          // 1.1 å›¾æ ‡å¼è¿”å›ï¼ˆè½»é‡ã€ä¸å æ–‡å­—ç©ºé—´ï¼‰
          Image($r('app.media.ic_back'))
            .fillColor(Color.Black)
            .width('10%')
            .height(30)
            .onClick(()=>{this.pageStack.pop() //è¿”å›ä¸Šä¸€é¡µ
            })
          /*          Text('æœç´¢ç»“æœ')
                      .fontSize(12)
                      .fontColor(app_color.text2)
                      .lineHeight(14)
                    Text(this.keyword)
                      .fontSize(16)
                      .fontWeight(FontWeight.Medium)
                      .fontColor(app_color.primary)
                      .maxLines(1)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })*/
          //å½“æˆ‘ç‚¹å‡»æœç´¢çš„ç»“æœçš„æ—¶å€™ï¼Œå¯ä»¥è¿›è¡Œä¿®æ”¹
          TextInput({
            placeholder: this.keyword
          })
            .layoutWeight(1)
            .textAlign(TextAlign.Center)// .backgroundColor('#FEC4DF')
            .onChange((value: string) => {
              this.productName = value;
            })// Text('æœç´¢èœè°± / é£Ÿæ / å•†æˆ·...')
            .fontSize(14)
            .fontColor('#9E9E9E')
          Button('æœç´¢')
            .width('20%')
            .height(40)
            .margin({ left: 10 })
            .backgroundColor('#4CAF50')
            .fontColor('#FFFFFF')
            .onClick(() => {
              if (!this.productName?.trim()) {
                promptAction.showToast({ message: 'è¯·è¾“å…¥å•†å“åç§°' });
                return;
              }

              // const params = new SearchParams(this.productName);
              // this.pageStack.pushPath({name:"SearchProductPage",param : this.productName })
/*              router.pushUrl({
                url: 'pages/Users/Home/SearchProductPage',
                params: { keyword: this.productName, animateCart: true }
              });*/
              this.pageStack.pushPathByName("SearchProductPage",this.productName)
            });
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
        .border({ width: 3, radius: 4, color: Color.Green })
        .height(56)
        .padding({ left: 16, right: 16 })
        .borderRadius(24)
        .margin({ top: 24, left: 16, right: 16 }) // ä¸å±å¹•ä¸¤ä¾§ç•™å‘¼å¸è·ç¦»
        /*      // 1. é¡¶éƒ¨æ ‡é¢˜æ 
              Row() {
                Button('è¿”å›')
                  .width(60)
                  .height(36)
                  .backgroundColor(app_color.primary)
                  .fontColor(Color.White)
                  .borderRadius(18)
                  .onClick(() => router.back())

                Text(`æœç´¢ç»“æœï¼š${this.keyword}`)
                  .fontSize(20)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(app_color.text1)
              }
              .width('100%')
              .border({width:3,color:Color.Black,radius:3})
              .justifyContent(FlexAlign.SpaceBetween)
              .padding({ top: 20, left: 16 })
              .backgroundColor(app_color.card)*/

        // åŠ è½½çŠ¶æ€
        if (this.isLoading) {
          Text('æ­£åœ¨åŠ è½½ä¸­...')
            .fontSize(16)
            .margin({ top: 40 });
        }
        // 3. ç©ºæ•°æ®
        else if (this.productList.length === 0) {
          Column() {
            Image($r('app.media.ic_empty'))
              .width(120).height(120).opacity(0.6)
            Text('æš‚æ— ç›¸å…³å•†å“')
              .fontSize(16)
              .fontColor(app_color.text2)
              .margin({ top: 12 })
          }
          .width('100%')
          .margin({ top: 60 })
        }
        // 4. å•†å“åˆ—è¡¨
        else {
          Scroll() {
            Stack() {
              List({ space: 12 }) {
                ForEach(this.productList, (item: ProductDataItem) => {
                  ListItem() {
                    Row() {
                      Image(item.imageUrl)
                        .width(80)
                        .height(80)
                        .borderRadius(12)
                        .shadow({
                          radius: 6,
                          color: app_color.shadow,
                          offsetX: 0,
                          offsetY: 2
                        })
                        .onClick(() => {
                          this.bigUrl = item.imageUrl;
                          this.bigShown = true
                        })

                      Column({ space: 6 }) {
                        Text(item.name)
                          .fontSize(17)
                          .fontWeight(FontWeight.Medium)
                          .fontColor(Color.Black)
                        Text(`ï¿¥${item.price} / ${item.unit}`)
                          .fontSize(15)
                          .fontColor(app_color.primary)
                          .fontWeight(FontWeight.Bold)
                        Row({ space: 6 }) {
                          if (item.isRecommend === 1) {
                            Text('ğŸ”¥ æ¨è')
                              .fontSize(11)
                              .backgroundColor(app_color.accentLight)
                              .fontColor(Color.White)
                              .padding({
                                left: 6,
                                right: 6,
                                top: 2,
                                bottom: 2
                              })
                              .borderRadius(4)
                          }
                          if (item.isNew === 1) {
                            Text('ğŸ†• æ–°å“')
                              .fontSize(11)
                              .backgroundColor(app_color.success)
                              .fontColor(Color.White)
                              .padding({
                                left: 6,
                                right: 6,
                                top: 2,
                                bottom: 2
                              })
                              .borderRadius(4)
                          }
                        }
                      }
                      .layoutWeight(1)
                      .margin({ left: 12 })

                      // åç»­å¼€å‘åŠ å…¥è´­ç‰©è½¦é€‰é¡¹

                      Row() {
                        Image($r('app.media.Shopping'))
                          .width(50)
                          .height(50)
                          .translate({ x: this.offsetX, y: this.offsetY })
                          .animation({ duration: 600, curve: Curve.EaseInOut })
                        /*                        .onClick(() => {
                                                    this.offsetX = this.offsetX === 0 ? 70 : 0
                                                    this.offsetY === 0
                                                })*/
                      }
                      .justifyContent(FlexAlign.End)

                    }
                    .width('100%').padding(12)

                  }
                  .border({ radius: 10 })
                  .backgroundColor('#FFEFD5')
                })

              }

              .width('100%')

              /* ---------------- æ”¾å¤§æ€ ---------------- */
              // if (this.showBig) {
              //   Column() {
              //     Image(this.bigUrl)
              //       .width(300)
              //       .height(300)
              //       .borderRadius(16)
              //       .shadow({ radius: 20, color: '#80000000' })
              //       .onClick(() => { // å†ç‚¹ä¸€æ¬¡ -> ç¼©å°
              //         this.showBig = false
              //       })
              //   }
              //   .width('100%')
              //   .height('100%')
              //   .backgroundColor('#80000000') // åŠé€æ˜é®ç½©
              //   .justifyContent(FlexAlign.Center)
              //   .position({ x: 0, y: 0 }) // æ‚¬æµ®å…¨å±
              //   .zIndex(999) // ä¿è¯åœ¨æœ€ä¸Šå±‚
              //   .transition({
              //     type: TransitionType.Insert, // å‡ºç°æ—¶çš„åŠ¨ç”»
              //     scale: {
              //       x: 0,
              //       y: 0,
              //       centerX: 0.5,
              //       centerY: 0.5
              //     }   // ä» 0 â†’ 1
              //   })
              //   .transition({
              //     type: TransitionType.Delete, // æ¶ˆå¤±æ—¶çš„åŠ¨ç”»
              //     scale: {
              //       x: 0,
              //       y: 0,
              //       centerX: 0.5,
              //       centerY: 0.5
              //     }   // ä» 1 â†’ 0
              //   })
              // }

            }

          }
          .padding({ bottom: 100 })
        }
      }
      .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])

      .bindContentCover(
        $$this.bigShown, // ç»‘å®šçš„â€œå¼€å…³â€å˜é‡
        this.BigCoverBuilder(), // çœŸæ­£çš„æ”¾å¤§ UI
        {
          modalTransition: ModalTransition.ALPHA, // æ·¡å…¥æ·¡å‡º
          backgroundColor: Color.Transparent,
          onDisappear: () => {
            this.bigUrl = ''; // æ¸…ç†çŠ¶æ€
            this.bigShown = false;

          }
        }
      )
    }
    // éšè—æœç´¢é¡µé¢çš„å¯¼èˆªæ 
    .hideTitleBar(true)
    .onReady((context: NavDestinationContext)=>{
      this.pageStack= context.pathStack;
      this.keyword = context.pathInfo.param as string ?? '';
      if (this.keyword) this.fetchProductData();
    })


  }


  @Builder
  BigCoverBuilder() {
    Stack() {
      // é»‘è‰²åŠé€æ˜é®ç½©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor(Color.Black)
        .shadow({ radius: 20, color: '#40000000' })
        .onClick(() => this.bigUrl = '') // ç‚¹é®ç½©å…³é—­

      // å¤§å›¾ï¼šæŒ‰å±å¹•çŸ­è¾¹è‡ªé€‚åº”
      Image(this.bigUrl)
        .width(this.bigImageSize())
        .height(this.bigImageSize())
        .borderRadius(16)
        .shadow({ radius: 20, color: '#80000000' })
        .objectFit(ImageFit.Contain)
        .onClick(() => {
          this.bigUrl = '';
          this.bigShown = false
        }) // ç‚¹å›¾æœ¬èº«ä¹Ÿå…³é—­
    }
    .width('100%')
    .height('100%')
    .alignContent(Alignment.Center)
    .animation({ duration: 250, curve: Curve.Friction })
  }

  // è¾…åŠ©ï¼šæ‰‹æœº/å¹³æ¿è‡ªé€‚åº”å¤§å°
  private bigImageSize(): number {
    const dsp = display.getDefaultDisplaySync() as display.Display;
    const short = Math.min(px2vp(dsp.width), px2vp(dsp.height));
    return Math.min(short * 0.78, 480); // æœ€å¤§ 480vp
  }
}
